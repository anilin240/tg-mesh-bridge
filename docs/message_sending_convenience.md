# üí¨ –£–î–û–ë–°–¢–í–û –û–¢–ü–†–ê–í–ö–ò –°–û–û–ë–©–ï–ù–ò–ô ‚Äî –í–´–ë–û–† –ù–û–î–´ –ö–ù–û–ü–ö–û–ô

**–î–∞—Ç–∞:** 14 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨ –†–ï–ê–õ–ò–ó–û–í–ê–ù–ê

---

## üéØ –¶–ï–õ–¨

–û–±–µ—Å–ø–µ—á–∏—Ç—å —É–¥–æ–±—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ –≤—ã–±–æ—Ä –Ω–æ–¥—ã –∫–Ω–æ–ø–∫–æ–π –ø–æ –∏–º–µ–Ω–∏:
- –í ¬´–ú–æ–∏ –Ω–æ–¥—ã ‚Üí –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª –¥–æ–±–∞–≤–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –Ω–æ–¥—ã
- –ü–æ ¬´–ù–∞–ø–∏—Å–∞—Ç—å¬ª —Å—Ç–∞–≤–∏—Ç—å state –∏ –ø–æ–ª—É—á–∞—Ç—å —Ç–µ–∫—Å—Ç
- –ü—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ MQTT —Å –∞–Ω—Ç–∏-–ø–µ—Ç–ª—ë–π [[TG]]
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ publish_downlink

---

## ‚úÖ **–ü–†–û–í–ï–†–ö–ê –†–ï–ê–õ–ò–ó–ê–¶–ò–ò**

### **1. –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –Ω–æ–¥—ã –≤ ¬´–ú–æ–∏ –Ω–æ–¥—ã ‚Üí –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª**
**–§–∞–π–ª:** `app/src/bot/keyboards/menu.py:35-39`

```python
def dev_actions_menu(lang: str, node_id: int) -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text=t(lang, "dev.action.write"),   callback_data=MenuCB(section="dev", action="write",  id=node_id).pack())],
        [InlineKeyboardButton(text=t(lang, "dev.action.rename"),  callback_data=MenuCB(section="dev", action="rename", id=node_id).pack())],
        [InlineKeyboardButton(text=t(lang, "dev.action.delete"),  callback_data=MenuCB(section="dev", action="del_one", id=node_id).pack())],
    ])
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ù–∞–ø–∏—Å–∞—Ç—å" —Å `action="write"` –∏ `id=node_id`
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" —Å `action="rename"` –∏ `id=node_id`
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å" —Å `action="del_one"` –∏ `id=node_id`

### **2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ ¬´–ù–∞–ø–∏—Å–∞—Ç—å¬ª**
**–§–∞–π–ª:** `app/src/bot/handlers/menu.py:162-178`

```python
elif callback_data.action == "write":
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è "–ù–∞–ø–∏—Å–∞—Ç—å" –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    if not callback_data.id:
        await cb.answer(t(lang, "error.unknown_command"))
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    from bridge.repo import get_device_by_id_for_user
    from bot.keyboards.menu import back_to_dev_menu
    device = get_device_by_id_for_user(callback_data.id, cb.from_user.id)
    if device:
        label = (getattr(device, "user_label", None) or device.alias or str(device.node_id))
        await cb.message.edit_text(
            t(lang, "dev.enter_message", label=label, node_id=device.node_id),
            reply_markup=back_to_dev_menu(lang), parse_mode="HTML"
        )
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ state_manager
        from bot.states import state_manager, UserState
        state_manager.set_state(cb.from_user.id, UserState.REGISTERING, {"action": "write", "node_id": callback_data.id})
    else:
        await cb.answer(t(lang, "error.unknown_command"))
        return
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è state —Å `action="write"` –∏ `node_id`
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "‚¨Ö –ù–∞–∑–∞–¥" –±–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω—é

### **3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏**
**–§–∞–π–ª:** `app/src/bot/main.py:260-270`

```python
elif action == "write" and node_id:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    from bridge.mqtt import publish_downlink
    payload = {"to": node_id, "type": "sendtext", "payload": f"[[TG]] {txt}"}
    ok = publish_downlink(payload)
    if ok:
        await message.answer(_t(lang, "dev.sent"), reply_markup=dev_menu(lang))
    else:
        await message.answer(_t(lang, "error.mqtt"), reply_markup=dev_menu(lang))
    state_manager.clear_state(message.from_user.id)
    return
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤ MQTT —Å –∞–Ω—Ç–∏-–ø–µ—Ç–ª—ë–π `[[TG]]`
- ‚úÖ Payload —Å–æ–¥–µ—Ä–∂–∏—Ç `to=node_id` –∏ `type="sendtext"`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—Ö–∞/–æ—à–∏–±–∫–∏ —Å i18n-–æ—Ç–≤–µ—Ç–æ–º
- ‚úÖ –û—á–∏—Å—Ç–∫–∞ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è

---

## üîç **–ü–†–û–í–ï–†–ö–ê –ï–î–ò–ù–û–û–ë–†–ê–ó–ù–û–ì–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø PUBLISH_DOWNLINK**

### **‚úÖ 1. –í main.py (–æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ –º–µ–Ω—é)**
```python
payload = {"to": node_id, "type": "sendtext", "payload": f"[[TG]] {txt}"}
ok = publish_downlink(payload)
```

### **‚úÖ 2. –í send_to_node.py (–∫–æ–º–∞–Ω–¥–∞ /send_to_node)**
```python
payload = {
    "from": gateway_node_id,
    "to": node_id,
    "type": "sendtext",
    "payload": f"[[TG]] {text_to_send}",
}
ok = publish_downlink(payload)
```

### **‚úÖ 3. –í send_nearby.py (–∫–æ–º–∞–Ω–¥–∞ /send_nearby)**
```python
payload = {
    "from": gateway_node_id,
    "to": node_id,
    "type": "sendtext",
    "payload": f"[[TG]] {text_to_send}",
}
ok = await asyncio.to_thread(publish_downlink, payload)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ï–î–ò–ù–û–û–ë–†–ê–ó–ù–û–ï –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï
- ‚úÖ –í—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç payload
- ‚úÖ –í—Å–µ –º–µ—Å—Ç–∞ –¥–æ–±–∞–≤–ª—è—é—Ç –∞–Ω—Ç–∏-–ø–µ—Ç–ª—é `[[TG]]`
- ‚úÖ –í—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `type="sendtext"`
- ‚úÖ –†–∞–∑–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –≤ –Ω–∞–ª–∏—á–∏–∏ –ø–æ–ª—è `from` (gateway_node_id)

---

## üìã **–°–¶–ï–ù–ê–†–ò–ô –†–ê–ë–û–¢–´**

### **‚úÖ –ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:**

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–æ–¥—É:**
   ```
   "–ú–æ–∏ –Ω–æ–¥—ã" ‚Üí "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ "–ú—ç—à—à–ø–∏–ª—å"
   ```

2. **–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π:**
   ```
   –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: –ú—ç—à—à–ø–∏–ª—å (ID: 123456)
   
   ‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å
   ‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å  
   üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
   üîô –ù–∞–∑–∞–¥
   ```

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–∞–ø–∏—Å–∞—Ç—å":**
   ```
   –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è UserState.REGISTERING —Å {"action": "write", "node_id": 123456}
   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è: "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ú—ç—à—à–ø–∏–ª—å (ID: 123456):"
   –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: [‚¨Ö –ù–∞–∑–∞–¥]
   ```

4. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç:**
   ```
   "–ü—Ä–∏–≤–µ—Ç, –ú—ç—à—à–ø–∏–ª—å!"
   ```

5. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ main.py:**
   ```python
   action == "write" and node_id == 123456
   payload = {"to": 123456, "type": "sendtext", "payload": "[[TG]] –ü—Ä–∏–≤–µ—Ç, –ú—ç—à—à–ø–∏–ª—å!"}
   ok = publish_downlink(payload)
   ```

6. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   ```
   –£—Å–ø–µ—Ö: "–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ." + –º–µ–Ω—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤
   –û—à–∏–±–∫–∞: "MQTT error" + –º–µ–Ω—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤
   FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–∞–µ—Ç—Å—è
   ```

---

## ‚úÖ **–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–¢–°–£–¢–°–¢–í–ò–Ø –í–í–û–î–ê ID**

### **‚úÖ –ù–∞ —ç—Ç–æ–º —à–∞–≥–µ –ù–ï–¢ –≤–≤–æ–¥–∞ ID:**
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤–≤–æ–¥–∏—Ç Node ID
- ‚ùå –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–∞—Ä—Å–∏–Ω–≥ ID
- ‚ùå –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—è ID
- ‚úÖ Node ID —É–∂–µ –∏–∑–≤–µ—Å—Ç–µ–Ω –∏–∑ callback_data.id
- ‚úÖ Node ID –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ state –∫–∞–∫ `node_id`
- ‚úÖ Node ID –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ payload

### **‚úÖ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**
```
callback_data.id (–∏–∑ –∫–Ω–æ–ø–∫–∏) ‚Üí state.node_id ‚Üí payload.to
```

---

## üîç **–ü–†–û–í–ï–†–ö–ê –ê–ù–¢–ò-–ü–ï–¢–õ–ò**

### **‚úÖ –ê–Ω—Ç–∏-–ø–µ—Ç–ª—è [[TG]] –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ:**
- ‚úÖ **main.py:** `f"[[TG]] {txt}"`
- ‚úÖ **send_to_node.py:** `f"[[TG]] {text_to_send}"`
- ‚úÖ **send_nearby.py:** `f"[[TG]] {text_to_send}"`

### **‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∞–Ω—Ç–∏-–ø–µ—Ç–ª–∏:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
- –°–æ–æ–±—â–µ–Ω–∏—è —Å `[[TG]]` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è consumer'–æ–º
- –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–±—Ä–∞—Ç–Ω–æ –≤ Telegram

---

## ‚úÖ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —É–¥–æ–±—Å—Ç–≤–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞:**

1. ‚úÖ **–î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –Ω–æ–¥—ã** - –∫–Ω–æ–ø–∫–∏ "–ù–∞–ø–∏—Å–∞—Ç—å", "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å", "–£–¥–∞–ª–∏—Ç—å"
2. ‚úÖ **–í—ã–±–æ—Ä –ø–æ –∏–º–µ–Ω–∏** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
3. ‚úÖ **State –¥–ª—è –≤–≤–æ–¥–∞** - UserState.REGISTERING —Å action="write"
4. ‚úÖ **–ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"** - –±–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω—é
5. ‚úÖ **MQTT –ø—É–±–ª–∏–∫–∞—Ü–∏—è** - —Å –∞–Ω—Ç–∏-–ø–µ—Ç–ª—ë–π [[TG]]
6. ‚úÖ **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - publish_downlink –≤–µ–∑–¥–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ
7. ‚úÖ **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–≤–æ–¥–∞ ID** - Node ID –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑ callback

### **‚úÖ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- **–£–¥–æ–±—Å—Ç–≤–æ** - –≤—ã–±–æ—Ä –Ω–æ–¥—ã –ø–æ –∏–º–µ–Ω–∏, –∞ –Ω–µ –ø–æ ID
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç MQTT —Å–æ–æ–±—â–µ–Ω–∏–π
- **–ê–Ω—Ç–∏-–ø–µ—Ç–ª—è** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞** - –Ω–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–≤–æ–¥–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ ID

**–¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ª–µ–≥–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è, –≤—ã–±–∏—Ä–∞—è –Ω–æ–¥—É –ø–æ –∫—Ä–∞—Å–∏–≤–æ–º—É –∏–º–µ–Ω–∏!** üéØ
