# üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´: "–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ‚Üí –î–æ–±–∞–≤–∏—Ç—å"

**–î–∞—Ç–∞:** 14 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üéØ –ü–†–û–ë–õ–ï–ú–ê

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ‚Üí –î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ":
1. ‚úÖ –ë–æ—Ç –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ Node ID
2. ‚ùå –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ Node ID "–Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç" - —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è

---

## üîç –ê–ù–ê–õ–ò–ó –û–ë–†–ê–ë–û–¢–ß–ò–ö–û–í

### ‚úÖ **1. Callback "–î–æ–±–∞–≤–∏—Ç—å" (menu.py:74-79)**
```python
elif callback_data.action == "add":
    logger.info("DEV ADD: User {} clicked 'Add device' button", cb.from_user.id)
    state_manager.set_state(cb.from_user.id, UserState.REGISTERING, {"action": "add"})
    logger.info("DEV ADD: Set UserState.REGISTERING with action=add for user {}", cb.from_user.id)
    await cb.message.edit_text(t(lang, "dev.enter_node_id"), reply_markup=dev_menu(lang), parse_mode="HTML")
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `UserState.REGISTERING` —Å `{"action": "add"}`
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ "–í–≤–µ–¥–∏—Ç–µ ID –Ω–æ–¥—ã"
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–Ω–µ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é)

### ‚ùå **2. Message-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è (main.py:224-250)**
```python
elif state_manager.is_in_state(message.from_user.id, UserState.REGISTERING):
    if action == "add":
        logger.info("DEV ADD: Got input '{}' for user {} in REGISTERING state", txt, message.from_user.id)
        try:
            node_id = int(txt, 0)
            logger.info("DEV ADD: Parsed node_id={} for user {}", node_id, message.from_user.id)
        except Exception:
            logger.warning("DEV ADD: Invalid node_id format '{}' for user {}", txt, message.from_user.id)
            await message.answer(_t(lang, "dev.enter_node_id"), reply_markup=dev_menu(lang))
            return
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ê–ë–û–¢–ê–ï–¢ (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

---

## üö® **–ù–ê–ô–î–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –ö–û–ù–§–õ–ò–ö–¢ –°–ò–°–¢–ï–ú –°–û–°–¢–û–Ø–ù–ò–ô**

### **–î–≤–µ —Å–∏—Å—Ç–µ–º—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π:**
1. **UserState.REGISTERING** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ main.py –∏ menu.py
2. **DevFSM.wait_node_id_for_add** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤ devices.py

### **–ü—Ä–æ–±–ª–µ–º–∞:**
- –í menu.py —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `UserState.REGISTERING`
- –í devices.py –æ–∂–∏–¥–∞–ª—Å—è `DevFSM.wait_node_id_for_add`
- –í main.py –µ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `@dp.message()` –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è
- dev_router —Å DevFSM –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª—É—á–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è

### **–ü–æ—Ä—è–¥–æ–∫ —Ä–æ—É—Ç–µ—Ä–æ–≤ –≤ main.py:**
```python
dp.include_router(nearby_router)
dp.include_router(send_to_node_router)
dp.include_router(send_nearby_router)
dp.include_router(status_router)
dp.include_router(menu_router)
dp.include_router(dev_router)  # ‚Üê –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–æ–ª—É—á–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è
dp.include_router(fallback_router)
```

**–ù–û:** –í main.py –µ—Å—Ç—å `@dp.message()` –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–∞–Ω—å—à–µ —Ä–æ—É—Ç–µ—Ä–æ–≤!

---

## üîß **–ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

### **1. –£–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ FSM —Å–æ—Å—Ç–æ—è–Ω–∏—è**
**–§–∞–π–ª:** `app/src/bot/handlers/devices.py`
- ‚ùå –£–¥–∞–ª—ë–Ω –∫–ª–∞—Å—Å `DevFSM`
- ‚ùå –£–¥–∞–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `@dev_router.message(DevFSM.wait_node_id_for_add)`
- ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ —Ä–æ—É—Ç–µ—Ä –¥–ª—è callback-–∑–∞–ø—Ä–æ—Å–æ–≤

### **2. –û–±–Ω–æ–≤–ª—ë–Ω fallback.py**
**–§–∞–π–ª:** `app/src/bot/handlers/fallback.py`
- ‚ùå –£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ DevFSM —Å–æ—Å—Ç–æ—è–Ω–∏–π
- ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ UserState.REGISTERING

### **3. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
**–§–∞–π–ª—ã:** `app/src/bot/handlers/menu.py`, `app/src/bot/main.py`
- ‚úÖ –õ–æ–≥–∏ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å"
- ‚úÖ –õ–æ–≥–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤–≤–æ–¥–∞ Node ID
- ‚úÖ –õ–æ–≥–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ Node ID

---

## ‚úÖ **–†–ï–ó–£–õ–¨–¢–ê–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø**

### **–¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
1. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–î–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ"
2. ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `UserState.REGISTERING` —Å `{"action": "add"}`
3. ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ "–í–≤–µ–¥–∏—Ç–µ ID –Ω–æ–¥—ã" —Å –º–µ–Ω—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤
4. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç Node ID
5. ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ main.py –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ–≥–æ
6. ‚úÖ –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞

### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:**
```
DEV ADD: User 123456789 clicked 'Add device' button
DEV ADD: Set UserState.REGISTERING with action=add for user 123456789
DEV ADD: Got input '123456' for user 123456789 in REGISTERING state
DEV ADD: Parsed node_id=123456 for user 123456789
```

---

## üîç **–ü–†–û–í–ï–†–ö–ê –î–†–£–ì–ò–• –ö–û–ú–ü–û–ù–ï–ù–¢–û–í**

### **‚úÖ Middleware rate-limit:**
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç callback-–∑–∞–ø—Ä–æ—Å—ã –º–µ–Ω—é
- –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ FSM
- –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã `/status`, `/help`

### **‚úÖ Fallback-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `UserState.REGISTERING` –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
- –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤–≤–æ–¥–∞
- –°—Ç–æ–∏—Ç –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞ —Ä–æ—É—Ç–µ—Ä–æ–≤ (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### **‚úÖ –ü–æ—Ä—è–¥–æ–∫ —Ä–æ—É—Ç–µ—Ä–æ–≤:**
- `@dp.message()` –≤ main.py –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
- fallback_router —Å—Ç–æ–∏—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–º
- dev_router –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω –¥–ª—è message-–æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## ‚úÖ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

**–ü—Ä–æ–±–ª–µ–º–∞ –±—ã–ª–∞ –≤ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –¥–≤—É—Ö —Å–∏—Å—Ç–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π:**
- UserState.REGISTERING (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- DevFSM.wait_node_id_for_add (—É–¥–∞–ª—ë–Ω)

**–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
1. ‚úÖ –û–¥–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π (UserState.REGISTERING)
2. ‚úÖ –û–¥–∏–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (main.py)
3. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏
4. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π "–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ‚Üí –î–æ–±–∞–≤–∏—Ç—å" —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!** üéØ
