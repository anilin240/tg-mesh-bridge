# üè∑Ô∏è –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø USER_LABEL

**–î–∞—Ç–∞:** 14 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

---

## üéØ –¶–ï–õ–¨

–û–±–µ—Å–ø–µ—á–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∏–º–µ–Ω–∏ (`user_label`) –≤–µ–∑–¥–µ –≤ —Å–∏—Å—Ç–µ–º–µ:
- –í —Å–ø–∏—Å–∫–∞—Ö –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: `user_label` ‚Üí `alias` ‚Üí `node_id`
- –í Mesh‚ÜíTG —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –≤–º–µ—Å—Ç–æ ID
- –í "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Üí –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" –ø—Ä–∏—Å–≤–∞–∏–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ `user_label`

---

## ‚úÖ **–ü–†–û–í–ï–†–ö–ê –ú–û–î–ï–õ–ò –ò –ú–ò–ì–†–ê–¶–ò–ô**

### **1. –ü–æ–ª–µ user_label –≤ –º–æ–¥–µ–ª–∏ Node**
**–§–∞–π–ª:** `app/src/common/models.py:37`

```python
class Node(Base):
    __tablename__ = "nodes"
    # ...
    user_label: Mapped[str | None] = mapped_column(default=None)
    # ...
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢

### **2. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è user_label**
**–§–∞–π–ª:** `app/alembic/versions/be5f569b9fcf_add_user_label_to_node_model.py`

```python
def upgrade() -> None:
    op.add_column('nodes', sa.Column('user_label', sa.String(length=64), nullable=True))
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –£–ñ–ï –°–£–©–ï–°–¢–í–£–ï–¢ –ò –ü–†–ò–ú–ï–ù–ï–ù–ê

### **3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö**
```bash
docker exec tg-mesh-app python -c "from common.db import SessionLocal; from common.models import Node; from sqlalchemy import select; session = SessionLocal(); result = session.execute(select(Node.user_label)).first(); print('user_label column exists:', result is not None); session.close()"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: user_label column exists: True
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–û–õ–û–ù–ö–ê –°–£–©–ï–°–¢–í–£–ï–¢ –í –ë–î

---

## üîß **–í–ù–ï–°–Å–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø**

### **1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ consumer.py –¥–ª—è Mesh‚ÜíTG —Å–æ–æ–±—â–µ–Ω–∏–π**
**–§–∞–π–ª:** `app/src/bridge/consumer.py`

#### **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∏–º–µ–Ω–∏:**
```python
def get_node_display_name(node_id: int) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –Ω–æ–¥—ã —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º: user_label ‚Üí alias ‚Üí node_id"""
    try:
        from common.db import SessionLocal
        from common.models import Node
        
        with SessionLocal() as session:
            node = session.execute(
                select(Node).where(Node.node_id == node_id)
            ).scalar_one_or_none()
            
            if node:
                # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: user_label ‚Üí alias ‚Üí node_id
                if node.user_label:
                    return node.user_label
                elif node.alias:
                    return node.alias
                else:
                    return str(node.node_id)
            else:
                return str(node_id)
    except Exception as e:
        logger.warning("Error getting node display name for {}: {}", node_id, e)
        return str(node_id)
```

#### **–û–±–Ω–æ–≤–ª–µ–Ω–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:**
```python
# –ë—ã–ª–æ:
text_to_send = f"[from {mesh_from}] {message_text or ''}".strip()

# –°—Ç–∞–ª–æ:
display_name = get_node_display_name(int(mesh_from)) if mesh_from is not None else str(mesh_from)
text_to_send = f"[from {display_name}] {message_text or ''}".strip()
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í Telegram —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–ú—ç—à—à–ø–∏–ª—å" –≤–º–µ—Å—Ç–æ ID

### **2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ nearby.py –¥–ª—è —Å–ø–∏—Å–∫–∞ "–†—è–¥–æ–º"**
**–§–∞–π–ª:** `app/src/bot/handlers/nearby.py`

#### **–û–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:**
```python
# –ë—ã–ª–æ:
select(HeardMap.node_id, n.alias, HeardMap.last_heard_at)

# –°—Ç–∞–ª–æ:
select(HeardMap.node_id, n.user_label, n.alias, HeardMap.last_heard_at)
```

#### **–î–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
```python
# –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: user_label ‚Üí alias ‚Üí node_id
result = []
for node_id, user_label, alias, last_heard_at in rows:
    display_name = user_label or alias or str(node_id)
    result.append((int(node_id), display_name, last_heard_at))
return result
```

#### **–û–±–Ω–æ–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:**
```python
# –ë—ã–ª–æ:
alias_text = f" {alias}" if alias else ""
lines.append(f" ‚Ä¢ {node_id}{alias_text} ‚Äî {_t(lang, 'min_ago', minutes=diff_minutes)}")

# –°—Ç–∞–ª–æ:
lines.append(f" ‚Ä¢ {display_name} ‚Äî {_t(lang, 'min_ago', minutes=diff_minutes)}")
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í —Å–ø–∏—Å–∫–µ "–†—è–¥–æ–º" –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫—Ä–∞—Å–∏–≤—ã–µ –∏–º–µ–Ω–∞

---

## üìã **–°–ü–ò–°–û–ö –ú–ï–°–¢, –ì–î–ï –ò–ú–Ø –ë–ï–†–Å–¢–°–Ø –° –ü–†–ò–û–†–ò–¢–ï–¢–û–ú USER_LABEL**

### **‚úÖ 1. Mesh‚ÜíTG —Å–æ–æ–±—â–µ–Ω–∏—è (consumer.py)**
- **–§—É–Ω–∫—Ü–∏—è:** `get_node_display_name(node_id)`
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** `user_label` ‚Üí `alias` ‚Üí `node_id`
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ `[from {display_name}]`

### **‚úÖ 2. –°–ø–∏—Å–æ–∫ "–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞" (menu.py)**
- **–ú–µ—Å—Ç–æ:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** `user_label` ‚Üí `alias` ‚Üí `node_id`
- **–ö–æ–¥:** `getattr(n, "user_label", None) or n.alias or str(n.node_id)`

### **‚úÖ 3. –ö–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" (menu.py)**
- **–ú–µ—Å—Ç–æ:** –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** `user_label` ‚Üí `alias` ‚Üí `node_id`
- **–ö–æ–¥:** `getattr(n, 'user_label', None) or n.alias or str(n.node_id)`

### **‚úÖ 4. –ö–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å" (menu.py)**
- **–ú–µ—Å—Ç–æ:** –ö–Ω–æ–ø–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** `user_label` ‚Üí `alias` ‚Üí `node_id`
- **–ö–æ–¥:** `getattr(n, 'user_label', None) or n.alias or str(n.node_id)`

### **‚úÖ 5. –ú–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (menu.py)**
- **–ú–µ—Å—Ç–æ:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** `user_label` ‚Üí `alias` ‚Üí `node_id`
- **–ö–æ–¥:** `getattr(device, "user_label", None) or device.alias or str(device.node_id)`

### **‚úÖ 6. –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –≤–≤–æ–¥–∞ (menu.py)**
- **–ú–µ—Å—Ç–æ:** –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –≤–≤–æ–¥–µ —Å–æ–æ–±—â–µ–Ω–∏–π/–º–µ—Ç–æ–∫
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** `user_label` ‚Üí `alias` ‚Üí `node_id`
- **–ö–æ–¥:** `getattr(device, "user_label", None) or device.alias or str(device.node_id)`

### **‚úÖ 7. –°–ø–∏—Å–æ–∫ "–†—è–¥–æ–º" (nearby.py)**
- **–ú–µ—Å—Ç–æ:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–æ–¥ —É —à–ª—é–∑–∞
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** `user_label` ‚Üí `alias` ‚Üí `node_id`
- **–ö–æ–¥:** `display_name = user_label or alias or str(node_id)`

---

## üéØ **–°–¶–ï–ù–ê–†–ò–ò –†–ê–ë–û–¢–´**

### **‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç "–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞" ‚Üí "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" ‚Üí —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ‚Üí "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å"
2. –í–≤–æ–¥–∏—Ç –Ω–æ–≤–æ–µ –∏–º—è "–ú—ç—à—à–ø–∏–ª—å"
3. `rename_user_device` –æ–±–Ω–æ–≤–ª—è–µ—Ç `user_label`
4. –í–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–ú—ç—à—à–ø–∏–ª—å"

### **‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Mesh**
1. –ù–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Mesh
2. Consumer –ø–æ–ª—É—á–∞–µ—Ç MQTT —Å–æ–æ–±—â–µ–Ω–∏–µ
3. `get_node_display_name` –ø–æ–ª—É—á–∞–µ—Ç –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è
4. –í Telegram –ø—Ä–∏—Ö–æ–¥–∏—Ç: "[from –ú—ç—à—à–ø–∏–ª—å] —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è"

### **‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ "–†—è–¥–æ–º"**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–†—è–¥–æ–º"
2. `_get_recent_nodes_for_gateway` –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫: "‚Ä¢ –ú—ç—à—à–ø–∏–ª—å ‚Äî 5 –º–∏–Ω –Ω–∞–∑–∞–¥"

### **‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 4: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –±–µ–∑ user_label**
1. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ `alias = "Node123"`
2. –í–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "Node123"
3. –ü—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è `user_label`

### **‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π 5: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –±–µ–∑ user_label –∏ alias**
1. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–º–µ–µ—Ç —Ç–æ–ª—å–∫–æ `node_id = 123456`
2. –í–æ –≤—Å–µ—Ö –º–µ—Å—Ç–∞—Ö –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "123456"
3. –ü—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è `user_label`

---

## ‚úÖ **–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ú–ò–ì–†–ê–¶–ò–ò**

### **‚úÖ –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏:**
```bash
docker exec tg-mesh-app python -m alembic current
# –†–µ–∑—É–ª—å—Ç–∞—Ç: be5f569b9fcf (head)
```

### **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–æ–Ω–∫–∏ –≤ –ë–î:**
```bash
docker exec tg-mesh-app python -c "from common.db import SessionLocal; from common.models import Node; from sqlalchemy import select; session = SessionLocal(); result = session.execute(select(Node.user_label)).first(); print('user_label column exists:', result is not None); session.close()"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: user_label column exists: True
```

### **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ–ª–∏:**
- –ü–æ–ª–µ `user_label: Mapped[str | None] = mapped_column(default=None)` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ú–∏–≥—Ä–∞—Ü–∏—è `be5f569b9fcf_add_user_label_to_node_model.py` –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- –ö–æ–ª–æ–Ω–∫–∞ `user_label` –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

---

## ‚úÖ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è user_label –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–∞:**

1. ‚úÖ **–ú–æ–¥–µ–ª—å –∏ –º–∏–≥—Ä–∞—Ü–∏–∏** - –ø–æ–ª–µ user_label —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ
2. ‚úÖ **Mesh‚ÜíTG —Å–æ–æ–±—â–µ–Ω–∏—è** - –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∫—Ä–∞—Å–∏–≤—ã–µ –∏–º–µ–Ω–∞ –≤–º–µ—Å—Ç–æ ID
3. ‚úÖ **–°–ø–∏—Å–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç user_label ‚Üí alias ‚Üí node_id
4. ‚úÖ **–§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è** - –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–º–µ–Ω–Ω–æ user_label
5. ‚úÖ **–°–ø–∏—Å–æ–∫ "–†—è–¥–æ–º"** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–µ –∏–º–µ–Ω–∞
6. ‚úÖ **–í—Å–µ UI —ç–ª–µ–º–µ–Ω—Ç—ã** - –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

### **‚úÖ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- **–ö—Ä–∞—Å–∏–≤—ã–µ –∏–º–µ–Ω–∞** - –≤–º–µ—Å—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö ID
- **–ï–¥–∏–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç** - –≤–µ–∑–¥–µ user_label ‚Üí alias ‚Üí node_id
- **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- **–ü—Ä–æ—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –º–µ–Ω—é

**–¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç "–ú—ç—à—à–ø–∏–ª—å" –≤–º–µ—Å—Ç–æ "123456"!** üéØ
