# üì® –£–õ–£–ß–®–ï–ù–ò–Ø –í–•–û–î–Ø–©–ò–• –°–û–û–ë–©–ï–ù–ò–ô –ò–ó MESH –í TG

**–î–∞—Ç–∞:** 14 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

---

## üéØ –¶–ï–õ–¨

–°–¥–µ–ª–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ –∏–∑ Mesh –≤ TG –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º–∏ –∏ –Ω–∞–¥—ë–∂–Ω—ã–º–∏:
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—Ä–∞—Å–∏–≤—ã–µ –∏–º–µ–Ω–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É user_label ‚Üí alias ‚Üí node_id
2. –ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—ã–π Bot –∏ asyncio.run –Ω–∞ –∫–∞–∂–¥—É—é –¥–æ—Å—Ç–∞–≤–∫—É
3. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ chat_id, node_id, —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

---

## ‚úÖ **1. –ö–†–ê–°–ò–í–´–ï –ò–ú–ï–ù–ê –í –°–û–û–ë–©–ï–ù–ò–Ø–•**

### **‚úÖ –§—É–Ω–∫—Ü–∏—è get_node_display_name**
**–§–∞–π–ª:** `app/src/bridge/consumer.py:40-60`

```python
def get_node_display_name(node_id: int) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –Ω–æ–¥—ã —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º: user_label ‚Üí alias ‚Üí node_id"""
    try:
        from common.db import SessionLocal
        from common.models import Node
        
        with SessionLocal() as session:
            node = session.execute(
                select(Node).where(Node.node_id == node_id)
            ).scalar_one_or_none()
            
            if node:
                # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: user_label ‚Üí alias ‚Üí node_id
                if node.user_label:
                    return node.user_label
                elif node.alias:
                    return node.alias
                else:
                    return str(node.node_id)
            else:
                return str(node_id)
    except Exception as e:
        logger.warning("Error getting node display name for {}: {}", node_id, e)
        return str(node_id)
```

#### **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞:**
```python
# –ü–æ–ª—É—á–∞–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –Ω–æ–¥—ã
display_name = get_node_display_name(int(mesh_from)) if mesh_from is not None else str(mesh_from)
text_to_send = f"[from {display_name}] {message_text or ''}".strip()
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: user_label ‚Üí alias ‚Üí node_id
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å fallback –Ω–∞ node_id
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è

---

## ‚úÖ **2. –ù–ê–î–Å–ñ–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê –ë–ï–ó –°–û–ó–î–ê–ù–ò–Ø –ù–û–í–û–ì–û BOT**

### **‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bot/loop –≤ main.py**
**–§–∞–π–ª:** `app/src/bot/main.py:62-65`

```python
bot = Bot(token=config.bot_token)
dp = Dispatcher()
from common.state import state
state.set_bot(bot)
state.set_loop(asyncio.get_running_loop())
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ Bot —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –≤ main.py
- ‚úÖ Loop —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –æ–±—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
- ‚úÖ –ù–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ Bot –≤ consumer

### **‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ asyncio.run_coroutine_threadsafe**
**–§–∞–π–ª:** `app/src/bridge/consumer.py:65-110`

```python
def _send_telegram_message(chat_id: int, text: str, ...):
    from common.state import state
    bot = state.bot
    loop = state.loop
    
    if not bot or not loop:
        logger.error("Bot/loop not initialized in state - cannot send message")
        return
    
    async def _send():
        try:
            await bot.send_message(chat_id=chat_id, text=text)
            logger.info("MESH‚ÜíTG SENT: chat_id={}, text='{}'", chat_id, text)
        except Exception as e:
            logger.error("MESH‚ÜíTG ERROR: chat_id={}, text='{}', error={}", chat_id, text, e)
    
    # –ü–ª–∞–Ω–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ event loop
    future = asyncio.run_coroutine_threadsafe(_send(), loop)
    try:
        future.result(timeout=30.0)
    except asyncio.TimeoutError:
        logger.error("MESH‚ÜíTG TIMEOUT: chat_id={}, text='{}' (30s)", chat_id, text)
    except Exception as e:
        logger.error("MESH‚ÜíTG THREAD ERROR: chat_id={}, text='{}', error={}", chat_id, text, e)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Bot –∏–∑ –æ–±—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Loop –∏–∑ –æ–±—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ asyncio.run_coroutine_threadsafe –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
- ‚úÖ –¢–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤

---

## ‚úÖ **3. –ü–û–î–†–û–ë–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï**

### **‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞**
**–§–∞–π–ª:** `app/src/bridge/consumer.py:247-250`

```python
# –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
logger.info("MESH‚ÜíTG: node_id={}, display_name='{}', chat_id={}, text='{}'", 
           mesh_from, display_name, tg_chat_id or tg_user_id, text_to_send)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ node_id - ID –Ω–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
- ‚úÖ display_name - –∫—Ä–∞—Å–∏–≤–æ–µ –∏–º—è –Ω–æ–¥—ã
- ‚úÖ chat_id - ID —á–∞—Ç–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
- ‚úÖ text - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

### **‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏**
**–§–∞–π–ª:** `app/src/bridge/consumer.py:95`

```python
logger.info("MESH‚ÜíTG SENT: chat_id={}, text='{}'", chat_id, text)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
- ‚úÖ chat_id –∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

### **‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫**
**–§–∞–π–ª:** `app/src/bridge/consumer.py:97, 103, 107`

```python
# –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
logger.error("MESH‚ÜíTG ERROR: chat_id={}, text='{}', error={}", chat_id, text, e)

# –¢–∞–π–º–∞—É—Ç
logger.error("MESH‚ÜíTG TIMEOUT: chat_id={}, text='{}' (30s)", chat_id, text)

# –û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
logger.error("MESH‚ÜíTG THREAD ERROR: chat_id={}, text='{}', error={}", chat_id, text, e)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
- ‚úÖ –í–∫–ª—é—á–µ–Ω–∏–µ chat_id –∏ —Ç–µ–∫—Å—Ç–∞ –≤ –ª–æ–≥–∏

---

## üìã **–°–ü–ò–°–û–ö –ú–ï–°–¢, –ì–î–ï –§–û–†–ú–ê–¢ –ò–ú–ï–ù–ò –ò –°–ü–û–°–û–ë –û–¢–ü–†–ê–í–ö–ò –ü–†–ê–í–ò–õ–¨–ù–´**

### **‚úÖ 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è**
**–ú–µ—Å—Ç–æ:** `app/src/bridge/consumer.py:245-247`
```python
display_name = get_node_display_name(int(mesh_from)) if mesh_from is not None else str(mesh_from)
text_to_send = f"[from {display_name}] {message_text or ''}".strip()
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–µ –∏–º–µ–Ω–∞

### **‚úÖ 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ –æ–±—â–∏–π Bot**
**–ú–µ—Å—Ç–æ:** `app/src/bridge/consumer.py:65-110`
```python
bot = state.bot
loop = state.loop
future = asyncio.run_coroutine_threadsafe(_send(), loop)
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π Bot

### **‚úÖ 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ main.py**
**–ú–µ—Å—Ç–æ:** `app/src/bot/main.py:62-65`
```python
bot = Bot(token=config.bot_token)
state.set_bot(bot)
state.set_loop(asyncio.get_running_loop())
```
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - Bot —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑

### **‚úÖ 4. –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
**–ú–µ—Å—Ç–∞:**
- `app/src/bridge/consumer.py:247-250` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è
- `app/src/bridge/consumer.py:95` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
- `app/src/bridge/consumer.py:97, 103, 107` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –≤–∫–ª—é—á–∞–µ—Ç chat_id, node_id, —Ç–µ–∫—Å—Ç

---

## üîç **–ü–†–û–í–ï–†–ö–ê –û–¢–°–£–¢–°–¢–í–ò–Ø –ü–†–û–ë–õ–ï–ú**

### **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è Bot:**
- ‚ùå `Bot(` - –ù–ï –ù–ê–ô–î–ï–ù–û –≤ consumer.py
- ‚ùå `asyncio.run(` - –ù–ï –ù–ê–ô–î–ï–ù–û –≤ consumer.py
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `state.bot` –∏ `state.loop`

### **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ `MESH‚ÜíTG:` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ `MESH‚ÜíTG SENT:` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
- ‚úÖ `MESH‚ÜíTG ERROR:` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
- ‚úÖ `MESH‚ÜíTG TIMEOUT:` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤

### **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∞—Å–∏–≤—ã—Ö –∏–º—ë–Ω:**
- ‚úÖ `get_node_display_name()` - —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: user_label ‚Üí alias ‚Üí node_id
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞

---

## ‚úÖ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

**–£–ª—É—á—à–µ–Ω–∏—è –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ Mesh –≤ TG –∑–∞–≤–µ—Ä—à–µ–Ω—ã:**

1. ‚úÖ **–ö—Ä–∞—Å–∏–≤—ã–µ –∏–º–µ–Ω–∞** - user_label ‚Üí alias ‚Üí node_id
2. ‚úÖ **–ù–∞–¥—ë–∂–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞** - –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ Bot
3. ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - chat_id, node_id, —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
4. ‚úÖ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫** - —Ç–∞–π–º–∞—É—Ç—ã, –∏—Å–∫–ª—é—á–µ–Ω–∏—è, –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏

### **‚úÖ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- **–î—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç—å** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç "–ú—ç—à—à–ø–∏–ª—å" –≤–º–µ—Å—Ç–æ "123456"
- **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö Bot —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
- **–û—Ç–ª–∞–¥–∫–∞** - –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Bot –∏ Loop

### **‚úÖ –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç: "[from –ú—ç—à—à–ø–∏–ª—å] –ü—Ä–∏–≤–µ—Ç –∏–∑ Mesh!"
–õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: "MESH‚ÜíTG: node_id=123456, display_name='–ú—ç—à—à–ø–∏–ª—å', chat_id=987654, text='[from –ú—ç—à—à–ø–∏–ª—å] –ü—Ä–∏–≤–µ—Ç –∏–∑ Mesh!'"
```

**–¢–µ–ø–µ—Ä—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Mesh –≤—ã–≥–ª—è–¥—è—Ç –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞–¥—ë–∂–Ω–æ!** üéØ
