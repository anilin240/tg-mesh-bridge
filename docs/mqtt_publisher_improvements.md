# üì° –£–õ–£–ß–®–ï–ù–ò–Ø MQTT –ü–£–ë–õ–ò–ö–ê–¶–ò–ò

**–î–∞—Ç–∞:** 14 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

---

## üéØ –¶–ï–õ–¨

–ò—Å–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (–∫–æ–≥–¥–∞ connect/disconnect –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤):
1. –°–¥–µ–ª–∞—Ç—å –≤ mqtt.py –æ–¥–∏–Ω ¬´–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π¬ª Publisher (paho.mqtt client + loop_start), —Å on_connect/on_disconnect –∏ lock
2. publish_downlink/publish_to_topic ‚Äî —Ç–æ–Ω–∫–∏–µ –æ–±—ë—Ä—Ç–∫–∏ –≤–æ–∫—Ä—É–≥ –æ–¥–Ω–æ–≥–æ Publisher
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –≤—ã–∑–æ–≤—ã (–≤–∫–ª—é—á–∞—è ¬´–ù–∞–ø–∏—Å–∞—Ç—å –Ω–æ–¥–µ¬ª) –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏–º–µ–Ω–Ω–æ publish_downlink, –∏ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

---

## ‚úÖ **1. –ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–´–ô PUBLISHER**

### **‚úÖ –ö–ª–∞—Å—Å _Publisher –≤ mqtt.py**
**–§–∞–π–ª:** `app/src/bridge/mqtt.py:25-110`

```python
class _Publisher:
    def __init__(self) -> None:
        self._client: mqtt.Client | None = None
        self._lock = threading.Lock()
        self._cfg_snapshot: tuple[str, int, str | None, str | None] | None = None

    def _on_disconnect(self, client: mqtt.Client, userdata: Any, reason_code: int, properties=None) -> None:
        logger.warning("MQTT publisher disconnected: code={}", reason_code)
        with self._lock:
            try:
                if self._client is not None:
                    try:
                        self._client.loop_stop()
                    except Exception:
                        pass
            finally:
                self._client = None

    def _ensure_client(self) -> mqtt.Client | None:
        """Create or re-create client if config changed or client is missing."""
        cfg = AppConfig()
        snapshot = (cfg.mqtt_host, int(cfg.mqtt_port), cfg.mqtt_user, cfg.mqtt_pass)
        with self._lock:
            try:
                need_new = (
                    self._client is None or self._cfg_snapshot != snapshot
                )
                if not need_new:
                    return self._client

                # Close previous client if any
                if self._client is not None:
                    try:
                        self._client.loop_stop()
                    except Exception:
                        pass
                    try:
                        self._client.disconnect()
                    except Exception:
                        pass
                    self._client = None

                client = mqtt.Client(mqtt.CallbackAPIVersion.VERSION2, client_id="tg-mesh-bot-publisher")
                if cfg.mqtt_user:
                    client.username_pw_set(cfg.mqtt_user, cfg.mqtt_pass or "")
                client.on_disconnect = self._on_disconnect
                client.connect(cfg.mqtt_host, int(cfg.mqtt_port))
                client.loop_start()

                self._client = client
                self._cfg_snapshot = snapshot
                logger.info("MQTT publisher connected to {}:{}", cfg.mqtt_host, cfg.mqtt_port)
                return self._client
            except Exception as e:
                logger.error("MQTT publisher ensure_client error: {}", e)
                self._client = None
                return None

    def publish(self, topic: str, payload_dict: dict[str, Any]) -> bool:
        try:
            client = self._ensure_client()
            if client is None:
                return False
            text = json.dumps(payload_dict, separators=(",", ":"))
            logger.info("Publishing to {}: {}", topic, text)
            info = client.publish(topic, payload=text, qos=0, retain=False)
            ok = True
            try:
                # paho-mqtt v2 returns MQTTMessageInfo with rc
                ok = getattr(info, "rc", mqtt.MQTT_ERR_SUCCESS) == mqtt.MQTT_ERR_SUCCESS
            except Exception:
                ok = True
            return bool(ok)
        except Exception as e:
            logger.error("MQTT publish error: {}", e)
            with self._lock:
                # Drop client so that next publish reconnects
                try:
                    if self._client is not None:
                        try:
                            self._client.loop_stop()
                        except Exception:
                            pass
                        try:
                            self._client.disconnect()
                        except Exception:
                            pass
                finally:
                    self._client = None
            return False
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –û–¥–∏–Ω –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π –∫–ª–∏–µ–Ω—Ç —Å `loop_start()`
- ‚úÖ `on_disconnect` callback –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ `threading.Lock()` –¥–ª—è –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –æ—á–∏—Å—Ç–∫–æ–π –∫–ª–∏–µ–Ω—Ç–∞

---

## ‚úÖ **2. –¢–û–ù–ö–ò–ï –û–ë–Å–†–¢–ö–ò**

### **‚úÖ –ï–¥–∏–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä Publisher**
**–§–∞–π–ª:** `app/src/bridge/mqtt.py:112`

```python
_publisher = _Publisher()
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –û–¥–∏–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä `_Publisher`

### **‚úÖ –§—É–Ω–∫—Ü–∏–∏-–æ–±—ë—Ä—Ç–∫–∏**
**–§–∞–π–ª:** `app/src/bridge/mqtt.py:115-125`

```python
def publish_downlink(payload_dict: dict[str, Any]) -> bool:
    topic = AppConfig().mqtt_topic_pub
    return _publisher.publish(topic, payload_dict)


def publish_to_topic(topic: str, payload_dict: dict[str, Any]) -> bool:
    return _publisher.publish(topic, payload_dict)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ `publish_downlink` - –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–æ–ø–∏–∫
- ‚úÖ `publish_to_topic` - –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫
- ‚úÖ –û–±–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω `_publisher`

---

## ‚úÖ **3. –ü–†–û–í–ï–†–ö–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø**

### **‚úÖ –í—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è publish_downlink**
**–§–∞–π–ª—ã –∏ —Å—Ç—Ä–æ–∫–∏:**

1. **`app/src/bot/main.py:231,233`**
   ```python
   from bridge.mqtt import publish_downlink
   ok = publish_downlink(payload)
   ```
   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ FSM

2. **`app/src/bot/handlers/send_to_node.py:7,84`**
   ```python
   from bridge.mqtt import publish_downlink
   ok = publish_downlink(payload)
   ```
   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–º–∞–Ω–¥–∞ `/send_to_node`

3. **`app/src/bot/handlers/send_nearby.py:10,94`**
   ```python
   from bridge.mqtt import publish_downlink
   ok = await asyncio.to_thread(publish_downlink, payload)
   ```
   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–º–∞–Ω–¥–∞ `/send_nearby`

4. **`app/src/bot/handlers/devices.py:7`**
   ```python
   from bridge.mqtt import publish_downlink
   ```
   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ò–º–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ FSM

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –≤—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `publish_downlink`

### **‚úÖ –í—Å–µ –º–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è publish_to_topic**
**–§–∞–π–ª—ã –∏ —Å—Ç—Ä–æ–∫–∏:**

1. **`app/src/bot/main.py:29,118`**
   ```python
   from bridge.mqtt import publish_to_topic
   ok = publish_to_topic(topic, {"ping": "probe", "ts": __import__("time").time()})
   ```
   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ö–æ–º–∞–Ω–¥–∞ `/probe`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `publish_to_topic`

---

## ‚úÖ **4. –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –û–®–ò–ë–û–ö**

### **‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Publisher**
**–§–∞–π–ª:** `app/src/bridge/mqtt.py`

```python
# –û—Ç–∫–ª—é—á–µ–Ω–∏—è
logger.warning("MQTT publisher disconnected: code={}", reason_code)

# –û—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
logger.error("MQTT publisher ensure_client error: {}", e)

# –û—à–∏–±–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
logger.error("MQTT publish error: {}", e)

# –£—Å–ø–µ—à–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
logger.info("MQTT publisher connected to {}:{}", cfg.mqtt_host, cfg.mqtt_port)

# –£—Å–ø–µ—à–Ω—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
logger.info("Publishing to {}: {}", topic, text)
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–ê–õ–ò–ó–û–í–ê–ù–û
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π

---

## üìã **–°–ü–ò–°–û–ö –ú–ï–°–¢, –ì–î–ï –†–ê–ù–¨–®–ï –°–û–ó–î–ê–í–ê–õ–°–Ø –ö–õ–ò–ï–ù–¢ –ù–ê –ö–ê–ñ–î–´–ô PUBLISH**

### **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø—Ä—è–º–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤**

**–ü–æ–∏—Å–∫ `mqtt.Client` –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–¥–µ:**
- ‚úÖ `app/src/bridge/mqtt.py:66` - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≤ Publisher
- ‚úÖ `app/src/bridge/consumer.py:353` - —Å–æ–∑–¥–∞–Ω–∏–µ –¥–ª—è Consumer (–ø–æ–¥–ø–∏—Å–∫–∞)

**–ü–æ–∏—Å–∫ `connect`/`disconnect`/`loop_start`/`loop_stop`:**
- ‚úÖ `app/src/bridge/mqtt.py` - —Ç–æ–ª—å–∫–æ –≤ Publisher –∫–ª–∞—Å—Å–µ
- ‚úÖ `app/src/bridge/consumer.py` - —Ç–æ–ª—å–∫–æ –≤ Consumer

**–ü–æ–∏—Å–∫ `publish`:**
- ‚úÖ `app/src/bridge/mqtt.py:82,89,121,125` - —Ç–æ–ª—å–∫–æ –≤ Publisher –∏ –æ–±—ë—Ä—Ç–∫–∞—Ö

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ù–ï–¢ –ü–†–Ø–ú–û–ì–û –°–û–ó–î–ê–ù–ò–Ø –ö–õ–ò–ï–ù–¢–û–í –ù–ê –ö–ê–ñ–î–´–ô PUBLISH

---

## ‚úÖ **–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ü–ï–†–ï–í–û–î–ê –ù–ê –ï–î–ò–ù–´–ô PUBLISHER**

### **‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   main.py       ‚îÇ    ‚îÇ  send_to_node   ‚îÇ    ‚îÇ  send_nearby    ‚îÇ
‚îÇ   (FSM write)   ‚îÇ    ‚îÇ   (/send_to)    ‚îÇ    ‚îÇ  (/send_nearby) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                      ‚îÇ                      ‚îÇ
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   bridge.mqtt             ‚îÇ
                    ‚îÇ   publish_downlink()      ‚îÇ
                    ‚îÇ   publish_to_topic()      ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   _Publisher              ‚îÇ
                    ‚îÇ   (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä)‚îÇ
                    ‚îÇ   - _client               ‚îÇ
                    ‚îÇ   - _lock                 ‚îÇ
                    ‚îÇ   - _ensure_client()      ‚îÇ
                    ‚îÇ   - publish()             ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   paho.mqtt.Client        ‚îÇ
                    ‚îÇ   (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π)         ‚îÇ
                    ‚îÇ   - loop_start()          ‚îÇ
                    ‚îÇ   - on_disconnect         ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **‚úÖ –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**

1. **‚úÖ –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**
   - –û–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ
   - `loop_start()` –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
   - –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

2. **‚úÖ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
   - `threading.Lock()` –∑–∞—â–∏—â–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–ª–∏–µ–Ω—Ç—É
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

3. **‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**
   - `on_disconnect` callback –æ—á–∏—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç
   - –°–ª–µ–¥—É—é—â–∏–π –≤—ã–∑–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

4. **‚úÖ –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è**
   - –í—Å–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏–¥—É—Ç —á–µ—Ä–µ–∑ –æ–¥–∏–Ω Publisher
   - –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

---

## üîç **–ü–†–û–í–ï–†–ö–ê –û–¢–°–£–¢–°–¢–í–ò–Ø –ü–†–û–ë–õ–ï–ú**

### **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤:**
- ‚ùå `mqtt.Client(` - –ù–ï –ù–ê–ô–î–ï–ù–û –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
- ‚ùå `connect(` - –ù–ï –ù–ê–ô–î–ï–ù–û –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
- ‚ùå `loop_start(` - –ù–ï –ù–ê–ô–î–ï–ù–û –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö
- ‚úÖ –¢–æ–ª—å–∫–æ –≤ `mqtt.py` (Publisher) –∏ `consumer.py` (Consumer)

### **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π:**
- ‚úÖ `publish_downlink` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–µ–∑–¥–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ `publish_to_topic` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è `/probe`
- ‚úÖ –ù–µ—Ç –ø—Ä—è–º—ã—Ö –≤—ã–∑–æ–≤–æ–≤ `client.publish`

### **‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
- ‚úÖ `MQTT publisher disconnected` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π
- ‚úÖ `MQTT publisher ensure_client error` - –æ—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è
- ‚úÖ `MQTT publish error` - –æ—à–∏–±–∫–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
- ‚úÖ `Publishing to` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–π

---

## ‚úÖ **–ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï**

**–£–ª—É—á—à–µ–Ω–∏—è MQTT –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã:**

1. ‚úÖ **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π Publisher** - –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç —Å `loop_start()`
2. ‚úÖ **–¢–æ–Ω–∫–∏–µ –æ–±—ë—Ä—Ç–∫–∏** - `publish_downlink`/`publish_to_topic`
3. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ –≤—ã–∑–æ–≤—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–±—ë—Ä—Ç–∫–∏
4. ‚úÖ **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –≤—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

### **‚úÖ –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:**
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –Ω–µ—Ç connect/disconnect –Ω–∞ –∫–∞–∂–¥—ã–π –≤—ã–∑–æ–≤
- **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- **–ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å** - Lock –∑–∞—â–∏—â–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–ª–∏–µ–Ω—Ç—É
- **–û—Ç–ª–∞–¥–∫–∞** - –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º

### **‚úÖ –ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
```
–ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: MQTT publisher connected to localhost:1883
–ü—É–±–ª–∏–∫–∞—Ü–∏—è: Publishing to msh/US/2/json/mqtt: {"to":123456,"type":"sendtext","payload":"[[TG]] Hello"}
–û—à–∏–±–∫–∞: MQTT publisher disconnected: code=1
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: MQTT publisher connected to localhost:1883
```

**–¢–µ–ø–µ—Ä—å MQTT –ø—É–±–ª–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π Publisher –±–µ–∑ –ø—Ä–æ–±–ª–µ–º —Å connect/disconnect!** üéØ
