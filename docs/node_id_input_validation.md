# üîç –£–õ–£–ß–®–ï–ù–ò–ï –í–ê–õ–ò–î–ê–¶–ò–ò –í–í–û–î–ê NODE ID

**–î–∞—Ç–∞:** 14 –∞–≤–≥—É—Å—Ç–∞ 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

---

## üéØ –¶–ï–õ–¨

–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –≤–≤–µ–¥—ë–Ω–Ω—ã–π ID –Ω–æ–¥—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç—Å—è –∏ –Ω–µ "–ª–æ–º–∞–µ—Ç —Ç–∏—à–∏–Ω–æ–π":
- –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∞–ª–∏–¥–Ω–æ–≥–æ/–Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –≤–≤–æ–¥–∞
- –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
- –û–±–µ—Å–ø–µ—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## üîß –í–ù–ï–°–Å–ù–ù–´–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

### **1. –ù–æ–≤—ã–π i18n –∫–ª—é—á –¥–ª—è –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞**
**–§–∞–π–ª:** `app/src/common/i18n.py`

```python
"dev.invalid_node_id": "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç Node ID. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 123456) –∏–ª–∏ hex (–Ω–∞–ø—Ä–∏–º–µ—Ä: 0x1A2B)."
"dev.invalid_node_id": "‚ùå Invalid Node ID format. Use number (e.g., 123456) or hex (e.g., 0x1A2B)."
```

### **2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ Node ID**
**–§–∞–π–ª:** `app/src/bot/main.py`

#### **–î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
try:
    node_id = int(txt, 0)  # –ø–æ–¥–¥–µ—Ä–∂–∫–∞ '123456' –∏ '0x1A2B'
    logger.info("DEV ADD: Parsed node_id={} for user {}", node_id, message.from_user.id)
except Exception:
    logger.warning("DEV ADD: Invalid node_id format '{}' for user {}", txt, message.from_user.id)
    await message.answer(_t(lang, "dev.enter_node_id"), reply_markup=dev_menu(lang))
    return
```

#### **–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
```python
logger.info("DEV ADD: Parsing node_id input '{}' for user {}", txt, message.from_user.id)
try:
    node_id = int(txt, 0)  # –ø–æ–¥–¥–µ—Ä–∂–∫–∞ '123456' –∏ '0x1A2B'
    logger.info("DEV ADD: Parse OK: node_id={} for user {}", node_id, message.from_user.id)
except Exception as e:
    logger.warning("DEV ADD: Parse ERROR: '{}' for user {} - {}", txt, message.from_user.id, str(e))
    from bot.keyboards.menu import back_to_dev_menu
    await message.answer(_t(lang, "dev.invalid_node_id"), reply_markup=back_to_dev_menu(lang))
    return
```

### **3. –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ-—Ñ—É–Ω–∫—Ü–∏–∏**
```python
logger.info("DEV ADD: Calling link_node_to_user_manual(node_id={}, tg_user_id={})", node_id, message.from_user.id)
res = link_node_to_user_manual(node_id=node_id, tg_user_id=message.from_user.id)
logger.info("DEV ADD: link_node_to_user_manual result: '{}' for user {}", res, message.from_user.id)

# ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ...

logger.info("DEV ADD: Clearing state for user {}", message.from_user.id)
state_manager.clear_state(message.from_user.id)
```

---

## üìã –ß–ï–ö-–õ–ò–°–¢ –û–ë–†–ê–ë–û–¢–ö–ò –í–í–û–î–ê

### **‚úÖ –í–∞–ª–∏–¥–Ω—ã–π –≤–≤–æ–¥:**

#### **–§–æ—Ä–º–∞—Ç 1: –î–µ—Å—è—Ç–∏—á–Ω–æ–µ —á–∏—Å–ª–æ**
- **–í–≤–æ–¥:** `123456`
- **–ü–∞—Ä—Å–∏–Ω–≥:** `int("123456", 0)` ‚Üí `123456`
- **–õ–æ–≥:** `DEV ADD: Parse OK: node_id=123456 for user 123456789`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—ã–∑–æ–≤ `link_node_to_user_manual(123456, 123456789)`

#### **–§–æ—Ä–º–∞—Ç 2: Hex —á–∏—Å–ª–æ**
- **–í–≤–æ–¥:** `0x1A2B`
- **–ü–∞—Ä—Å–∏–Ω–≥:** `int("0x1A2B", 0)` ‚Üí `6699`
- **–õ–æ–≥:** `DEV ADD: Parse OK: node_id=6699 for user 123456789`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—ã–∑–æ–≤ `link_node_to_user_manual(6699, 123456789)`

#### **–§–æ—Ä–º–∞—Ç 3: Hex –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞**
- **–í–≤–æ–¥:** `1A2B`
- **–ü–∞—Ä—Å–∏–Ω–≥:** `int("1A2B", 0)` ‚Üí `6699`
- **–õ–æ–≥:** `DEV ADD: Parse OK: node_id=6699 for user 123456789`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—ã–∑–æ–≤ `link_node_to_user_manual(6699, 123456789)`

### **‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π –≤–≤–æ–¥:**

#### **–§–æ—Ä–º–∞—Ç 1: –ë—É–∫–≤—ã**
- **–í–≤–æ–¥:** `ABCD`
- **–ü–∞—Ä—Å–∏–Ω–≥:** `int("ABCD", 0)` ‚Üí `ValueError`
- **–õ–æ–≥:** `DEV ADD: Parse ERROR: 'ABCD' for user 123456789 - invalid literal for int() with base 0`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ + –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"

#### **–§–æ—Ä–º–∞—Ç 2: –°–º–µ—à–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç**
- **–í–≤–æ–¥:** `123abc`
- **–ü–∞—Ä—Å–∏–Ω–≥:** `int("123abc", 0)` ‚Üí `ValueError`
- **–õ–æ–≥:** `DEV ADD: Parse ERROR: '123abc' for user 123456789 - invalid literal for int() with base 0`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ + –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"

#### **–§–æ—Ä–º–∞—Ç 3: –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞**
- **–í–≤–æ–¥:** `""`
- **–ü–∞—Ä—Å–∏–Ω–≥:** `int("", 0)` ‚Üí `ValueError`
- **–õ–æ–≥:** `DEV ADD: Parse ERROR: '' for user 123456789 - invalid literal for int() with base 0`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ + –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"

---

## üéØ –ü–û–í–ï–î–ï–ù–ò–ï –ü–û –û–®–ò–ë–ö–ê–ú

### **‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞:**
1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º –≤–≤–æ–¥–∞ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º
2. **–°–æ–æ–±—â–µ–Ω–∏–µ:** –î—Ä—É–∂–µ–ª—é–±–Ω–æ–µ i18n —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤
3. **–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞:** `back_to_dev_menu(lang)` (—Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥")
4. **–°–æ—Å—Ç–æ—è–Ω–∏–µ:** –û—Å—Ç–∞—ë—Ç—Å—è `UserState.REGISTERING` —Å `{"action": "add"}`
5. **–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–≤–æ–¥ –∏–ª–∏ –Ω–∞–∂–∞—Ç—å "–ù–∞–∑–∞–¥"

### **‚úÖ –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ:**
1. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –£—Å–ø–µ—à–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º node_id
2. **–í—ã–∑–æ–≤ —Ä–µ–ø–æ:** `link_node_to_user_manual(node_id, tg_user_id)`
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:** –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–ø–æ-—Ñ—É–Ω–∫—Ü–∏–∏
4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:**
   - `"ok"` ‚Üí "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ: {node_id}"
   - `"already"` ‚Üí "–≠—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ –≤–∞–º"
   - `"owned_by_other"` ‚Üí "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø—Ä–∏–≤—è–∑–∞–Ω–æ –∫ –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"
   - `"limit"` ‚Üí "–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç: 3 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç"
5. **–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞:** `dev_menu(lang)` (–º–µ–Ω—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
6. **–°–æ—Å—Ç–æ—è–Ω–∏–µ:** –û—á–∏—â–∞–µ—Ç—Å—è (`state_manager.clear_state`)

---

## üîç –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ù–ê–õ–ò–ß–ò–Ø –õ–û–ì–û–í

### **‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ª–æ–≥–∏:**

1. **–ù–∞—á–∞–ª–æ –ø–∞—Ä—Å–∏–Ω–≥–∞:**
   ```
   DEV ADD: Parsing node_id input '123456' for user 123456789
   ```

2. **–£—Å–ø–µ—à–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥:**
   ```
   DEV ADD: Parse OK: node_id=123456 for user 123456789
   ```

3. **–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:**
   ```
   DEV ADD: Parse ERROR: 'ABCD' for user 123456789 - invalid literal for int() with base 0
   ```

4. **–í—ã–∑–æ–≤ —Ä–µ–ø–æ-—Ñ—É–Ω–∫—Ü–∏–∏:**
   ```
   DEV ADD: Calling link_node_to_user_manual(node_id=123456, tg_user_id=123456789)
   ```

5. **–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–µ–ø–æ-—Ñ—É–Ω–∫—Ü–∏–∏:**
   ```
   DEV ADD: link_node_to_user_manual result: 'ok' for user 123456789
   ```

6. **–û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**
   ```
   DEV ADD: Clearing state for user 123456789
   ```

### **‚úÖ –ü–æ–ª–Ω—ã–π –ª–æ–≥-–ø–æ—Ç–æ–∫ –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:**
```
DEV ADD: User 123456789 clicked 'Add device' button
DEV ADD: Set UserState.REGISTERING with action=add for user 123456789
DEV ADD: Parsing node_id input '123456' for user 123456789
DEV ADD: Parse OK: node_id=123456 for user 123456789
DEV ADD: Calling link_node_to_user_manual(node_id=123456, tg_user_id=123456789)
DEV ADD: link_node_to_user_manual result: 'ok' for user 123456789
DEV ADD: Clearing state for user 123456789
```

### **‚úÖ –ü–æ–ª–Ω—ã–π –ª–æ–≥-–ø–æ—Ç–æ–∫ –¥–ª—è –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞:**
```
DEV ADD: User 123456789 clicked 'Add device' button
DEV ADD: Set UserState.REGISTERING with action=add for user 123456789
DEV ADD: Parsing node_id input 'ABCD' for user 123456789
DEV ADD: Parse ERROR: 'ABCD' for user 123456789 - invalid literal for int() with base 0
```

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢ –£–õ–£–ß–®–ï–ù–ò–Ø

### **–î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- ‚ùå –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ—Å—å –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –º–µ–Ω—é (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
- ‚ùå –ù–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
- ‚ùå –ù–µ—Ç –¥—Ä—É–∂–µ–ª—é–±–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ "–∑–∞—Å—Ç—Ä—è—Ç—å" –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏

### **–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–µ—Å—è—Ç–∏—á–Ω—ã—Ö –∏ hex —Ñ–æ—Ä–º–∞—Ç–æ–≤
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–≤–æ–¥ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å

### **–£–ª—É—á—à–µ–Ω–∏—è UX:**
1. **–ü–æ–Ω—è—Ç–Ω—ã–µ –æ—à–∏–±–∫–∏** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–Ω–∞–µ—Ç, —á—Ç–æ –≤–≤–µ—Å—Ç–∏
2. **–ì–∏–±–∫–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–æ–≤** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∏—Å–ª–∞ –∏ hex
3. **–û—Ç–ª–∞–¥–∫–∞** - –ø–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
4. **–ù–∞–≤–∏–≥–∞—Ü–∏—è** - –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –¥–ª—è –æ—Ç–º–µ–Ω—ã

---

## ‚úÖ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–í–∞–ª–∏–¥–∞—Ü–∏—è –≤–≤–æ–¥–∞ Node ID –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–ª—É—á—à–µ–Ω–∞:**

1. ‚úÖ **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤** - –¥–µ—Å—è—Ç–∏—á–Ω—ã–µ —á–∏—Å–ª–∞ –∏ hex
2. ‚úÖ **–î—Ä—É–∂–µ–ª—é–±–Ω—ã–µ –æ—à–∏–±–∫–∏** - –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
3. ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤
4. ‚úÖ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤–≤–æ–¥
5. ‚úÖ **–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è** - –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

**–¢–µ–ø–µ—Ä—å –≤–≤–æ–¥ Node ID —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ –∏ –Ω–µ "–ª–æ–º–∞–µ—Ç —Ç–∏—à–∏–Ω–æ–π"!** üéØ
